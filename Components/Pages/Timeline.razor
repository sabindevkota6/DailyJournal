@page "/timeline"
@inject DailyJournal.Core.Services.IJournalService JournalService
@inject NavigationManager Nav
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@using MudBlazor
@using DailyJournal.Data.Models

<!-- timeline page container -->
<div class="timeline-container">
    <!-- page header -->
    <div class="timeline-header">
        <MudText Typo="Typo.h4" Class="timeline-title">Timeline</MudText>
        <MudText Typo="Typo.body2" Class="timeline-subtitle">View, edit, and manage your journal entries</MudText>
    </div>

    <!-- search and filter bar -->
    <div class="search-filter-bar">
        <MudTextField @bind-Value="searchQuery"
                      Placeholder="Search by title or content..."
                      Variant="Variant.Outlined"
                      Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.Search"
                      Class="search-field"
                      Immediate="true"
                      DebounceInterval="300"
                      OnDebounceIntervalElapsed="OnSearchChanged" />

        <MudBadge Content="@GetActiveFilterCount()" Color="MudColor.Error" Overlap="true" Visible="@(GetActiveFilterCount() > 0)">
            <MudButton Variant="Variant.Filled"
                       Color="MudColor.Default"
                       StartIcon="@Icons.Material.Filled.FilterList"
                       OnClick="@(() => showFilters = !showFilters)"
                       Class="filter-button">
                Filters
            </MudButton>
        </MudBadge>
    </div>

    <!-- filter panel -->
    @if (showFilters)
    {
        <MudPaper Class="filter-panel" Elevation="1">
            <div class="filter-header">
                <MudText Typo="Typo.h6">Filters</MudText>
                <MudButton Variant="Variant.Text"
                           Color="MudColor.Primary"
                           OnClick="ClearFilters"
                           Size="MudSize.Small">
                    Clear all
                </MudButton>
            </div>

            <!-- date range filter -->
            <div class="filter-section">
                <MudText Typo="Typo.subtitle2" Class="filter-title">Date Range</MudText>
                <div class="date-range-inputs">
                    <MudDatePicker @bind-Date="filterStartDate"
                                   Label="Start Date"
                                   Variant="Variant.Outlined"
                                   DateFormat="MM/dd/yyyy"
                                   Class="date-picker" />
                    <MudDatePicker @bind-Date="filterEndDate"
                                   Label="End Date"
                                   Variant="Variant.Outlined"
                                   DateFormat="MM/dd/yyyy"
                                   Class="date-picker" />
                </div>
            </div>

            <!-- moods filter -->
            <div class="filter-section">
                <MudText Typo="Typo.subtitle2" Class="filter-title">Moods</MudText>
                <div class="filter-chips">
                    @foreach (var mood in AllMoods)
                    {
                        <MudChip T="string"
                                 Text="@mood.ToString()"
                                 Color="@(selectedMoodFilters.Contains(mood) ? MudColor.Primary : MudColor.Default)"
                                 Variant="@(selectedMoodFilters.Contains(mood) ? Variant.Filled : Variant.Outlined)"
                                 OnClick="@(() => ToggleMoodFilter(mood))"
                                 Size="MudSize.Small">
                            @mood
                        </MudChip>
                    }
                </div>
            </div>

            <!-- tags filter -->
            <div class="filter-section">
                <MudText Typo="Typo.subtitle2" Class="filter-title">Tags</MudText>
                <div class="filter-chips">
                    @foreach (var tag in AvailableTags)
                    {
                        <MudChip T="string"
                                 Text="@tag"
                                 Color="@(selectedTagFilters.Contains(tag) ? MudColor.Primary : MudColor.Default)"
                                 Variant="@(selectedTagFilters.Contains(tag) ? Variant.Filled : Variant.Outlined)"
                                 Icon="@Icons.Material.Filled.Tag"
                                 OnClick="@(() => ToggleTagFilter(tag))"
                                 Size="MudSize.Small">
                            @tag
                        </MudChip>
                    }
                </div>
            </div>

            <!-- apply filters button -->
            <div class="filter-actions">
                <MudButton Variant="Variant.Filled"
                           Color="MudColor.Primary"
                           OnClick="ApplyFilters"
                           FullWidth="true">
                    Apply Filters
                </MudButton>
            </div>
        </MudPaper>
    }

    @if (isLoading)
    {
        <!-- loading indicator -->
        <div class="loading-section">
            <MudProgressCircular Color="MudColor.Primary" Indeterminate="true" />
            <MudText Typo="Typo.body1" Class="mt-3">Loading entries...</MudText>
        </div>
    }
    else if (!entries.Any())
    {
        <!-- empty state -->
        <MudPaper Class="pa-6 text-center empty-state">
            <MudIcon Icon="@Icons.Material.Filled.EventNote" Size="MudSize.Large" Class="empty-state-icon" />
            <MudText Typo="Typo.h6" Class="mt-3">No Entries Yet</MudText>
            <MudText Typo="Typo.body2" Class="empty-state-subtitle">Start journaling by creating your first entry!</MudText>
            <MudButton Variant="Variant.Filled" Color="MudColor.Primary" OnClick="@(() => Nav.NavigateTo("/new-entry"))" Class="mt-4 empty-state-button">
                Create Entry
            </MudButton>
        </MudPaper>
    }
    else
    {
        <!-- timeline entries list (paginated) -->
        <div class="timeline-entries">
            @foreach (var entry in PaginatedEntries)
            {
                <MudCard Class="timeline-card">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <div class="entry-header">
                                <div>
                                    <MudText Typo="Typo.h6">@entry.Title</MudText>
                                    <div class="entry-metadata">
                                        <span class="metadata-text">@entry.Date.ToString("MMMM dd, yyyy")</span>
                                        <span class="metadata-separator">|</span>
                                        <span class="metadata-text">@entry.CreatedAt.ToString("g")</span>
                                        <MudIcon Icon="@Icons.Material.Filled.AccessTime" Size="MudSize.Small" Class="metadata-icon" />
                                    </div>
                                </div>
                            </div>
                        </CardHeaderContent>
                        <CardHeaderActions>
                            <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                           Color="MudColor.Default"
                                           Size="MudSize.Small"
                                           Class="edit-icon-button"
                                           OnClick="@(() => EditEntry(entry))" />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                           Color="MudColor.Default"
                                           Size="MudSize.Small"
                                           Class="delete-icon-button"
                                           OnClick="@(() => DeleteEntry(entry))" />
                        </CardHeaderActions>
                    </MudCardHeader>
                    <MudCardContent>
                        <div class="entry-content-preview">
                            @((MarkupString)GetContentPreview(entry.Content))
                        </div>
                    </MudCardContent>
                    <MudCardActions Class="card-actions-footer">
                        <div class="mood-tag-section">
                            @if (entry.Tags.Any())
                            {
                                <div class="tags-section">
                                    <span class="tags-label-inline">Tags:</span>
                                    @foreach (var tag in entry.Tags)
                                    {
                                        <span class="tag-chip-styled">@tag</span>
                                    }
                                </div>
                            }
                            <div class="mood-button-row">
                                <div class="mood-section">
                                    <span class="mood-label">Primary Mood:</span>
                                    <span class="mood-chip @GetMoodCategoryClass(entry.Category ?? Category.Neutral)">@((entry.Category ?? Category.Neutral).ToString())</span>
                                    @if (entry.SecondaryMoods.Any())
                                    {
                                        <span class="mood-separator">|</span>
                                        <span class="mood-label">Secondary Mood:</span>
                                        @foreach (var mood in entry.SecondaryMoods)
                                        {
                                            <span class="mood-chip mood-chip-secondary">@mood</span>
                                        }
                                    }
                                </div>
                                <MudButton Variant="Variant.Filled" Class="view-entry-button" OnClick="@(() => ViewEntry(entry))">View Full Entry</MudButton>
                            </div>
                        </div>
                    </MudCardActions>
                </MudCard>
            }
        </div>

        <!-- pagination controls -->
        @if (TotalPages > 1)
        {
            <div class="pagination-container">
                <div class="pagination-controls">
                    <button class="pagination-nav-btn" @onclick="@(() => currentPage--)" disabled="@(currentPage == 1)">
                        <MudIcon Icon="@Icons.Material.Filled.ChevronLeft" Size="MudSize.Small" />
                    </button>

                    @for (int i = 1; i <= TotalPages; i++)
                    {
                        var pageNum = i;
                        <button class="pagination-page-btn @(pageNum == currentPage ? "active" : "")" @onclick="@(() => currentPage = pageNum)">
                            @pageNum
                        </button>
                    }

                    <button class="pagination-nav-btn" @onclick="@(() => currentPage++)" disabled="@(currentPage == TotalPages)">
                        <MudIcon Icon="@Icons.Material.Filled.ChevronRight" Size="MudSize.Small" />
                    </button>
                </div>
            </div>
        }
    }
</div>

@code {
    private List<JournalEntry> entries = new();
    private List<JournalEntry> allEntries = new();
    private bool isLoading = true;
    private bool showFilters = false;
    private string searchQuery = "";
    private DateTime? filterStartDate;
    private DateTime? filterEndDate;
    private HashSet<Mood> selectedMoodFilters = new();
    private readonly Mood[] AllMoods = Enum.GetValues<Mood>();
    private HashSet<string> selectedTagFilters = new();
    private List<string> AvailableTags = new();

    // pagination
    private int currentPage = 1;
    private const int PageSize = 4;
    private int TotalPages => (int)Math.Ceiling((double)entries.Count / PageSize);
    private List<JournalEntry> PaginatedEntries => entries.Skip((currentPage - 1) * PageSize).Take(PageSize).ToList();

    protected override async Task OnInitializedAsync()
    {
        await LoadEntries();
        AvailableTags = allEntries.SelectMany(e => e.Tags).Distinct().OrderBy(t => t).ToList();
    }

    private async Task LoadEntries()
    {
        try
        {
            isLoading = true;
            allEntries = await JournalService.SearchAsync();
            entries = allEntries;
            currentPage = 1;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading entries: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private int GetActiveFilterCount()
    {
        int count = 0;
        if (filterStartDate.HasValue) count++;
        if (filterEndDate.HasValue) count++;
        count += selectedMoodFilters.Count;
        count += selectedTagFilters.Count;
        return count;
    }

    private void ToggleMoodFilter(Mood mood)
    {
        if (!selectedMoodFilters.Remove(mood))
            selectedMoodFilters.Add(mood);
    }

    private void ToggleTagFilter(string tag)
    {
        if (!selectedTagFilters.Remove(tag))
            selectedTagFilters.Add(tag);
    }

    private async Task OnSearchChanged() => await ApplyFilters();

    private async Task ApplyFilters()
    {
        try
        {
            isLoading = true;
            entries = await JournalService.SearchAsync(
                query: string.IsNullOrWhiteSpace(searchQuery) ? null : searchQuery,
                start: filterStartDate,
                end: filterEndDate,
                moods: selectedMoodFilters.Any() ? selectedMoodFilters : null,
                tags: selectedTagFilters.Any() ? selectedTagFilters : null
            );
            currentPage = 1;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error applying filters: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ClearFilters()
    {
        searchQuery = "";
        filterStartDate = null;
        filterEndDate = null;
        selectedMoodFilters.Clear();
        selectedTagFilters.Clear();
        entries = allEntries;
        currentPage = 1;
    }

    private string GetMoodCategoryClass(Category category) => category switch
    {
        Category.Positive => "mood-chip-positive",
        Category.Negative => "mood-chip-negative",
        _ => "mood-chip-neutral"
    };

    private string GetContentPreview(string content)
    {
        if (string.IsNullOrWhiteSpace(content)) return "<em>No content</em>";
        var text = System.Text.RegularExpressions.Regex.Replace(content, "<.*?>", string.Empty);
        var preview = text.Length > 200 ? text[..200] + "..." : text;
        return System.Net.WebUtility.HtmlEncode(preview);
    }

    private void ViewEntry(JournalEntry entry) => Nav.NavigateTo($"/entry-view/{entry.Id}");

    private void EditEntry(JournalEntry entry) => Nav.NavigateTo($"/entry-edit/{entry.Id}");

    private async Task DeleteEntry(JournalEntry entry)
    {
        var result = await DialogService.ShowMessageBox(
            "Delete Entry",
            $"Are you sure you want to delete the entry from {entry.Date:MMMM dd, yyyy}? This action cannot be undone.",
            yesText: "Delete",
            cancelText: "Cancel");

        if (result == true)
        {
            try
            {
                var deleted = await JournalService.DeleteEntryByIdAsync(entry.Id);
                if (deleted)
                {
                    Snackbar.Add("Entry deleted successfully", Severity.Success);
                    await LoadEntries();
                    AvailableTags = allEntries.SelectMany(e => e.Tags).Distinct().OrderBy(t => t).ToList();
                    if (currentPage > TotalPages && TotalPages > 0) currentPage = TotalPages;
                }
                else
                {
                    Snackbar.Add("Entry not found", Severity.Warning);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error deleting entry: {ex.Message}", Severity.Error);
            }
        }
    }
}
