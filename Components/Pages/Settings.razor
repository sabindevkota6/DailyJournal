@page "/settings"
@inject DailyJournal.Core.Services.IUserService UserService
@inject DailyJournal.Core.Services.IThemeService ThemeService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@using MudBlazor
@using DailyJournal.Core.Services
@using DailyJournal.Components.Dialogs
@implements IDisposable

<div class="settings-container">
 <div class="settings-header">
        <MudText Typo="Typo.h4">Settings</MudText>
    <MudText Typo="Typo.body2" Color="MudColor.Secondary">Manage your journal preferences</MudText>
    </div>

    <!-- Appearance Section -->
    <MudPaper Class="settings-section" Elevation="1">
     <div class="section-header">
     <MudIcon Icon="@Icons.Material.Filled.Palette" Size="MudSize.Small" />
        <MudText Typo="Typo.h6">Appearance</MudText>
        </div>
      
    <MudText Typo="Typo.body2" Color="MudColor.Secondary" Class="section-subtitle">
          Choose your preferred theme
        </MudText>

   <div class="theme-buttons">
    <button class="theme-mode-btn @(selectedTheme == AppThemeMode.Light ? "active" : "")"
    @onclick="@(() => SelectTheme(AppThemeMode.Light))">
                <MudIcon Icon="@Icons.Material.Filled.LightMode" Size="MudSize.Large" />
     <span>Light Mode</span>
            </button>

            <button class="theme-mode-btn @(selectedTheme == AppThemeMode.Dark ? "active" : "")"
      @onclick="@(() => SelectTheme(AppThemeMode.Dark))">
         <MudIcon Icon="@Icons.Material.Filled.DarkMode" Size="MudSize.Large" />
 <span>Dark Mode</span>
    </button>
        </div>
  </MudPaper>

    <!-- Security & Privacy Section -->
    <MudPaper Class="settings-section" Elevation="1">
        <div class="section-header">
            <MudIcon Icon="@Icons.Material.Filled.Security" Size="MudSize.Small" />
    <MudText Typo="Typo.h6">Security & Privacy</MudText>
        </div>

  <MudButton Variant="Variant.Filled"
           Color="MudColor.Dark"
     FullWidth="true"
          Size="MudSize.Large"
       OnClick="OpenChangePinDialog"
            Class="change-pin-button"
StartIcon="@Icons.Material.Filled.Lock">
            Change PIN
        </MudButton>
    </MudPaper>
</div>

@code {
    private AppThemeMode selectedTheme;

    protected override async Task OnInitializedAsync()
    {
        selectedTheme = ThemeService.Mode;
   ThemeService.Changed += OnThemeChanged;
        await Task.CompletedTask;
    }

    private async Task SelectTheme(AppThemeMode mode)
  {
     if (selectedTheme != mode)
      {
            selectedTheme = mode;
       await ThemeService.SetModeAsync(mode);
    Snackbar.Add($"Theme changed to {mode} mode", Severity.Success);
        }
    }

    private void OnThemeChanged()
    {
        selectedTheme = ThemeService.Mode;
        InvokeAsync(StateHasChanged);
  }

    private async Task OpenChangePinDialog()
    {
        var options = new DialogOptions 
  { 
          MaxWidth = MaxWidth.Small, 
            FullWidth = true, 
            CloseButton = true,
         CloseOnEscapeKey = true
      };

        var dialog = await DialogService.ShowAsync<ChangePinDialog>("Change PIN", options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
   {
    // Success message is already shown in the dialog
      }
}

    public void Dispose()
    {
        ThemeService.Changed -= OnThemeChanged;
 }
}
