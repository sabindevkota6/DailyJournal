@page "/entry-edit/{EntryId:guid}"
@inject IJSRuntime JS
@inject DailyJournal.Core.Services.IJournalService JournalService
@inject NavigationManager Nav
@inject ISnackbar Snackbar
@using MudBlazor
@using DailyJournal.Data.Models
@implements IAsyncDisposable

<!-- entry edit page container -->
<div class="entry-edit-container">
    @if (isLoading)
    {
        <!-- loading indicator -->
        <div class="loading-section">
            <MudProgressCircular Color="MudColor.Primary" Indeterminate="true" />
        </div>
    }
    else if (entry == null)
    {
        <!-- entry not found state -->
        <MudAlert Severity="Severity.Error">Entry not found</MudAlert>
        <MudButton Variant="Variant.Text" OnClick="@(() => Nav.NavigateTo("/timeline"))" Class="mt-3">
            Back to Timeline
        </MudButton>
    }
    else
    {
        <!-- page header with save and cancel buttons -->
        <div class="entry-edit-header">
            <div>
                <MudText Typo="Typo.h5" Class="entry-title">Edit Entry</MudText>
                <MudText Typo="Typo.body2" Class="entry-date">@entry.Date.ToString("dddd, MMMM dd, yyyy")</MudText>
            </div>
            <div class="header-actions">
                <MudButton Variant="Variant.Filled"
                           StartIcon="@Icons.Material.Filled.Close"
                           OnClick="Cancel"
                           Class="cancel-button">
                    Cancel
                </MudButton>
                <MudButton Variant="Variant.Filled"
                           StartIcon="@Icons.Material.Filled.Save"
                           OnClick="SaveEntry"
                           Class="save-button">
                    Save Changes
                </MudButton>
            </div>
        </div>

        <div class="entry-edit-content">
            <!-- title input -->
            <div class="section-title">Title *</div>
            <MudTextField @bind-Value="title" Placeholder="Give your entry a title..." Variant="Variant.Outlined" Class="title-input" />

            <!-- content editor with Quill -->
            <div class="section-title">Content *</div>
            <div id="quill-editor-edit" class="quill-editor"></div>

            <!-- mood selection section -->
            <div class="section-title">Mood * (Select Primary Mood, then optionally up to 2 secondary moods)</div>

            <!-- primary mood category selection -->
            <div class="mood-category-section">
                <MudText Typo="Typo.body2" Class="subsection-title">Primary Mood *</MudText>
                <div class="mood-chips">
                    <button class="mood-chip-btn @(selectedCategory == Category.Positive ? "active positive" : "")"
                            @onclick="@(() => SelectCategory(Category.Positive))">
                        Positive
                    </button>
                    <button class="mood-chip-btn @(selectedCategory == Category.Neutral ? "active neutral" : "")"
                            @onclick="@(() => SelectCategory(Category.Neutral))">
                        Neutral
                    </button>
                    <button class="mood-chip-btn @(selectedCategory == Category.Negative ? "active negative" : "")"
                            @onclick="@(() => SelectCategory(Category.Negative))">
                        Negative
                    </button>
                </div>
            </div>

            <!-- secondary mood selection -->
            @if (selectedCategory.HasValue)
            {
                <div class="specific-moods-section">
                    <MudText Typo="Typo.body2" Class="subsection-title">Secondary Moods (Optional - up to 2 for @selectedCategory.Value):</MudText>
                    <div class="mood-chips-wrap">
                        @foreach (var mood in GetMoodsForCategory(selectedCategory.Value))
                        {
                            <button class="mood-chip-btn-small @(selectedMoods.Contains(mood) ? "active" : "")"
                                    @onclick="@(() => ToggleMood(mood))">
                                @mood
                            </button>
                        }
                    </div>
                </div>
            }

            <!-- tags section -->
            <div class="section-title">Tags (Optional)</div>
            <div class="tags-section">
                <!-- custom tag input -->
                <div class="custom-tag-input">
                    <MudTextField @bind-Value="customTag" Placeholder="Custom tag..." Variant="Variant.Outlined" Class="tag-textfield" />
                    <MudButton Variant="Variant.Filled" Color="MudColor.Default" OnClick="AddCustomTag" Class="add-tag-btn">ADD</MudButton>
                </div>

                <!-- toggle for prebuilt tags -->
                @if (!showPrebuiltTags)
                {
                    <MudButton Variant="Variant.Text" OnClick="@(() => showPrebuiltTags = true)" StartIcon="@Icons.Material.Filled.Add" Class="show-tags-btn">
                        Show Tags
                    </MudButton>
                }
                else
                {
                    <MudButton Variant="Variant.Text" OnClick="@(() => showPrebuiltTags = false)" StartIcon="@Icons.Material.Filled.Remove" Class="hide-tags-btn">
                        Hide Tags
                    </MudButton>
                }

                <!-- selected tags display -->
                @if (selectedTags.Any())
                {
                    <div class="selected-tags">
                        @foreach (var tag in selectedTags)
                        {
                            <span class="tag-chip active">
                                @tag
                                <button class="tag-close-btn" @onclick="@(() => RemoveTag(tag))">×</button>
                            </span>
                        }
                    </div>
                }

                <!-- prebuilt tags list -->
                @if (showPrebuiltTags)
                {
                    <div class="prebuilt-tags">
                        @foreach (var tag in PrebuiltTags)
                        {
                            <button class="tag-chip @(selectedTags.Contains(tag) ? "active" : "")"
                                    @onclick="@(() => ToggleTag(tag))">
                                @tag
                            </button>
                        }
                    </div>
                }
            </div>
        </div>
    }
</div>

@code {
    // entry ID from route parameter
    [Parameter]
    public Guid EntryId { get; set; }

    // journal entry data
    private JournalEntry? entry;

    // loading and editor states
    private bool isLoading = true;
    private bool editorInitialized = false;
    private bool editorInitializing = false;

    // form fields
    private string title = "";
    private string content = "";
    private Category? selectedCategory;
    private List<Mood> selectedMoods = new();
    private HashSet<string> selectedTags = new();
    private string customTag = "";
    private bool showPrebuiltTags = false;

    // prebuilt tag options
    private readonly string[] PrebuiltTags = new[]
    {
        "Work", "Career", "Studies", "Projects", "Planning", "Family", "Friends", "Relationships", "Parenting", "Health",
        "Fitness", "Exercise", "Self-care", "Meditation", "Yoga", "Personal Growth", "Reflection", "Reading", "Writing",
        "Hobbies", "Travel", "Nature", "Music", "Cooking", "Shopping", "Birthday", "Holiday", "Vacation", "Celebration",
        "Finance", "Spirituality"
    };

    // initializing the entry edit page
    protected override async Task OnInitializedAsync()
    {
        await LoadEntry();
    }

    // initializing the Quill editor after render
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (entry != null && !editorInitialized && !editorInitializing && !isLoading)
        {
            editorInitializing = true;
            try
            {
                await JS.InvokeVoidAsync("quillInterop.destroy", "quill-editor-edit");

                await JS.InvokeVoidAsync("quillInterop.create", "quill-editor-edit", false, "Write your thoughts...");
                await JS.InvokeVoidAsync("quillInterop.setHTML", "quill-editor-edit", entry.Content);
                editorInitialized = true;
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"Error initializing Quill editor: {ex.Message}");
                editorInitializing = false;
            }
        }
    }

    // loading the journal entry by ID
    private async Task LoadEntry()
    {
        try
        {
            isLoading = true;
            entry = await JournalService.GetEntryByIdAsync(EntryId);
            if (entry == null)
            {
                Snackbar.Add("Entry not found", Severity.Warning);
            }
            else
            {
                // populating form fields with entry data
                title = entry.Title;
                content = entry.Content;
                selectedCategory = entry.Category;

                // loading secondary moods that the user selected
                selectedMoods = entry.SecondaryMoods?.ToList() ?? new List<Mood>();

                selectedTags = entry.Tags.ToHashSet();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading entry: {ex.Message}", Severity.Error);
            System.Diagnostics.Debug.WriteLine(ex);
        }
        finally
        {
            isLoading = false;
        }
    }

    // selecting primary mood category
    private void SelectCategory(Category category)
    {
        try
        {
            selectedCategory = category;
            // clearing moods when category changes to prevent cross category selection
            selectedMoods.Clear();
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error selecting category: {ex.Message}");
        }
    }

    // getting available moods for a category
    private List<Mood> GetMoodsForCategory(Category category) => category switch
    {
        Category.Positive => new() { Mood.Happy, Mood.Excited, Mood.Relaxed, Mood.Grateful, Mood.Confident },
        Category.Neutral => new() { Mood.Calm, Mood.Thoughtful, Mood.Curious, Mood.Nostalgic, Mood.Bored },
        Category.Negative => new() { Mood.Sad, Mood.Angry, Mood.Stressed, Mood.Lonely, Mood.Anxious },
        _ => new()
    };

    // toggling secondary mood selection
    private void ToggleMood(Mood mood)
    {
        try
        {
            if (selectedMoods.Contains(mood))
            {
                selectedMoods.Remove(mood);
            }
            else if (selectedMoods.Count < 2)
            {
                selectedMoods.Add(mood);
            }
            else
            {
                Snackbar.Add("You can select up to 2 secondary moods. The oldest selection was replaced.", Severity.Info);
                selectedMoods.RemoveAt(0);
                selectedMoods.Add(mood);
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error toggling mood: {ex.Message}");
            Snackbar.Add("Error updating mood selection", Severity.Warning);
        }
    }

    // toggling tag selection
    private void ToggleTag(string tag)
    {
        try
        {
            if (selectedTags.Contains(tag))
                selectedTags.Remove(tag);
            else
                selectedTags.Add(tag);
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error toggling tag: {ex.Message}");
        }
    }

    // removing a selected tag
    private void RemoveTag(string tag)
    {
        try
        {
            selectedTags.Remove(tag);
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error removing tag: {ex.Message}");
        }
    }

    // adding a custom tag
    private void AddCustomTag()
    {
        try
        {
            if (!string.IsNullOrWhiteSpace(customTag))
            {
                selectedTags.Add(customTag.Trim());
                customTag = "";
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error adding custom tag: {ex.Message}");
            Snackbar.Add("Error adding tag", Severity.Warning);
        }
    }

    // saving the updated entry
    private async Task SaveEntry()
    {
        try
        {
            // getting content from Quill editor
            content = await JS.InvokeAsync<string>("quillInterop.getHTML", "quill-editor-edit");

            // validating title
            if (string.IsNullOrWhiteSpace(title))
            {
                Snackbar.Add("Please enter a title", Severity.Warning);
                return;
            }

            // validating content
            if (string.IsNullOrWhiteSpace(content))
            {
                Snackbar.Add("Please write some content", Severity.Warning);
                return;
            }

            // validating primary mood
            if (!selectedCategory.HasValue)
            {
                Snackbar.Add("Please select a primary mood", Severity.Warning);
                return;
            }

            // mapping category to primary mood for database
            var primaryMood = selectedCategory.Value switch
            {
                Category.Positive => Mood.Happy,
                Category.Neutral => Mood.Calm,
                Category.Negative => Mood.Sad,
                _ => Mood.Calm
            };

            var secondaryMoods = selectedMoods.ToList();

            // updating the entry
            await JournalService.UpdateEntryAsync(
                EntryId,
                title,
                content,
                false,
                primaryMood,
                secondaryMoods,
                selectedCategory,
                selectedTags.ToList()
            );

            Snackbar.Add("Entry updated successfully!", Severity.Success);
            Nav.NavigateTo($"/entry-view/{EntryId}");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving entry: {ex.Message}", Severity.Error);
            System.Diagnostics.Debug.WriteLine(ex);
        }
    }

    // canceling and navigating back to entry view
    private void Cancel() => Nav.NavigateTo($"/entry-view/{EntryId}");

    // disposing the Quill editor
    public async ValueTask DisposeAsync()
    {
        try
        {
            await JS.InvokeVoidAsync("quillInterop.destroy", "quill-editor-edit");
        }
        catch { }
    }
}
